---
title: "Spatial Regression of Stormwater Pollutants"
author: "Christian Nilsen"
output:
  html_document:
    s8data_print: paged
---
This notebook demonstrates spatial regression of stormwater pollutant data for Puget Sound. It combines stormwater outfall monitoring data with spatial regression to predict pollutant concentrations across Puget Sound. 

The stormwater outfall data is available from the Department of Ecology at
https://data.wa.gov/Natural-Resources-Environment/Municipal-Stormwater-Permit-Outfall-Data/d958-q2ci
It uses the Socrata REST api in the form of 

https://data.wa.gov/resource/d958-q2ci.json?parameter=Copper%20-%20Water%20-%20Total

```{r echo=FALSE}
library(RSocrata)
if (!require('dplyr')) install.packages('dplyr')
if (!require('NADA')) install.packages('NADA')
if (!require('RSocrata')) install.packages('RSocrata')
if (!require('Hmisc')) install.packages('Hmisc')

install.packages('tidyverse')
install.packages('formattable')

library(NADA)
library(RSocrata)
library(dplyr)
library(Hmisc)
library(formattable)


url <- ("https://data.wa.gov/resource/rc6b-fvgb.json")
parameter <- 'Copper - Water - Total'
#construct the SQL call 
#apiCall <- paste0(url,"?$where=Result_Data_Qualifier<>'REJ' AND parameter= ","'",parameter,"'")
apiCall <- paste0(url,"?$where=parameter= ","'",parameter,"'")
data <-as_tibble(read.socrata(apiCall))
data <- (filter(data,!result_data_qualifier %in% 'REJ'))
data <- type.convert(data)

```
Looks OK

```{r echo=TRUE}
#read in spatial data and join
s8data <- data %>% 
  dplyr::select(location_id,study_name, parameter,season,new_result_value,nondetect_flag, new_result_units,field_collection_start_date) #sampling data
luLookup <-
 (read.csv("Data/luLookup.csv",  na = "NA")) #land use data
eeIndicies <-
  read.csv("Data/eeIndiciesNorm.csv") #spatial parameters
s8xy <-
  read.csv("Data/s8xy.csv") #xy coordinates of sampling locations

#execute join and do some fomatting
names(s8data)[1] <- "Location"
s8data <- s8data %>%
    merge(eeIndicies, by = "Location") %>%
    merge(luLookup, by = "Location") %>%
    merge(s8xy, by = "Location") 
#s8data <- as_tibble(s8data)
s8data$Year <- with(s8data, format(as.Date(field_collection_start_date),"%Y"))

#Trim location names so that Port of Seattle outfall locations are the same (all same study)
s8data$Location <- substr(s8data$Location, 1, 12)
#Plot data to view
plot <- ggplot(data = s8data) + 
  geom_point(mapping = aes(x = 1, y = new_result_value, color = study_name), position = 'jitter')  
plot+ggtitle(paste0(s8data$parameter, ' (',s8data$new_result_units,')'))
```
Looks good 

```{r}
s8data$Loc.Year <- paste0(s8data$Location, '-', s8data$Year)
# Box plot with dot plot
plot <- ggplot(data = s8data) + 
  geom_boxplot(mapping = aes(x = Year, y = new_result_value, color = study_name))
plot + facet_grid(vars(study_name))

```


Since the data set has mixed detection limits, we will use the kaplan-meier estimator to evaluate median values
```{r}
#first determine which are censored and which are not 
obs      <- as.numeric(s8data$new_result_value)
censored <-as.logical(s8data$nondetect_flag)
a <-tibble(numOfSamples = length(obs), PercentCensored = pctCen(obs, censored ))

formattable(a)
groups = as.factor(s8data$Location)

KM = cenfit(obs, censored, groups)
formattable(summary(KM.medians))
##plot(KM)
#plot with ggfortify



```

